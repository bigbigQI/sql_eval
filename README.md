# Text2SQL è¯„ä¼°ç³»ç»Ÿ

è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„Text2SQLè¯„ä¼°ç³»ç»Ÿï¼Œç”¨äºè¯„ä¼°å¤§è¯­è¨€æ¨¡å‹åœ¨SQLç”Ÿæˆä»»åŠ¡ä¸Šçš„æ€§èƒ½ã€‚è¯¥ç³»ç»Ÿæ”¯æŒå¤šè½®å¯¹è¯ã€å·¥å…·è°ƒç”¨å’Œå…¨é¢çš„ç»“æœåˆ†æã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸ”„ **å¤šè½®å¯¹è¯ç®¡ç†**: æ”¯æŒä¸SGLangæœåŠ¡å™¨çš„å¤šè½®å¯¹è¯äº¤äº’
- ğŸ› ï¸ **SQLå·¥å…·è°ƒç”¨**: é›†æˆSQLæ‰§è¡Œå·¥å…·ï¼Œæ”¯æŒå®é™…æ•°æ®åº“æŸ¥è¯¢
- ğŸ“Š **å…¨é¢è¯„ä¼°**: å¤šç»´åº¦è¯„ä¼°æŒ‡æ ‡ï¼ŒåŒ…æ‹¬æ‰§è¡Œå‡†ç¡®ç‡ã€æ ¼å¼å‡†ç¡®ç‡ç­‰
- ğŸ“ˆ **ç»“æœåˆ†æ**: è¯¦ç»†çš„é”™è¯¯åˆ†æã€æ€§èƒ½åˆ†æå’Œæ”¹è¿›å»ºè®®
- ğŸš€ **å¹¶å‘å¤„ç†**: æ”¯æŒå¤šå¹¶å‘è¯·æ±‚ï¼Œæé«˜è¯„ä¼°æ•ˆç‡
- ğŸ“ **å¤šæ•°æ®æº**: æ”¯æŒSynSQLã€Spiderã€BIRDç­‰å¤šç§æ•°æ®æº

## ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è¯„ä¼°æ•°æ®é›†     â”‚    â”‚   SGLang Server â”‚    â”‚   SQLæ•°æ®åº“     â”‚
â”‚   - é—®é¢˜        â”‚    â”‚   - æ¨¡å‹æ¨ç†    â”‚    â”‚   - æ‰§è¡Œç¯å¢ƒ    â”‚
â”‚   - æ•°æ®åº“ä¿¡æ¯   â”‚â”€â”€â”€â–ºâ”‚   - å¤šè½®å¯¹è¯    â”‚â—„â”€â”€â–ºâ”‚   - ç»“æœéªŒè¯    â”‚
â”‚   - Golden SQL â”‚    â”‚   - å·¥å…·è°ƒç”¨    â”‚    â”‚   - æ€§èƒ½æµ‹è¯•    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      è¯„ä¼°è„šæœ¬                                    â”‚
â”‚  - Promptæ„é€   - è¯·æ±‚ç®¡ç†  - ç»“æœè§£æ  - æ€§èƒ½è¯„ä¼°  - æŠ¥å‘Šç”Ÿæˆ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å®‰è£…ä¾èµ–

```bash
pip install aiohttp pandas sqlite3 pathlib
```

å¯é€‰ä¾èµ–ï¼š
```bash
pip install func_timeout  # ç”¨äºSQLæ‰§è¡Œè¶…æ—¶æ§åˆ¶
```

## å¿«é€Ÿå¼€å§‹

### 1. å‡†å¤‡æ•°æ®

ç¡®ä¿ä½ æœ‰ä»¥ä¸‹æ•°æ®ï¼š
- è¯„ä¼°æ•°æ®é›†æ–‡ä»¶ï¼ˆæ”¯æŒ.jsonã€.jsonlã€.parquetæ ¼å¼ï¼‰
- æ•°æ®åº“æ–‡ä»¶ï¼ˆSQLiteæ ¼å¼ï¼‰
- è¿è¡Œä¸­çš„SGLangæœåŠ¡å™¨

### 2. å¯åŠ¨SGLangæœåŠ¡å™¨

```bash
# å¯åŠ¨SGLangæœåŠ¡å™¨ï¼ˆç¤ºä¾‹ï¼‰
python -m sglang.launch_server \
    --model-path /path/to/your/model \
    --host 0.0.0.0 \
    --port 8001
```

### 3. è¿è¡Œè¯„ä¼°

```bash
python -m sql_eval.main_eval \
    --dataset_path /path/to/your/dataset.json \
    --db_root_path /path/to/your/databases \
    --server_url http://localhost:8001 \
    --sample_size 1 \
    --output_dir ./results
```

## è¯¦ç»†ä½¿ç”¨è¯´æ˜

### å‘½ä»¤è¡Œå‚æ•°

#### å¿…éœ€å‚æ•°

- `--dataset_path`: è¯„ä¼°æ•°æ®é›†æ–‡ä»¶è·¯å¾„
- `--db_root_path`: æ•°æ®åº“æ–‡ä»¶æ ¹ç›®å½•
- `--server_url`: SGLangæœåŠ¡å™¨URL

#### å¯é€‰å‚æ•°

- `--output_dir`: ç»“æœè¾“å‡ºç›®å½•ï¼ˆé»˜è®¤ï¼š./resultsï¼‰
- `--sample_size`: è¯„ä¼°æ ·æœ¬æ•°é‡ï¼ˆé»˜è®¤ï¼šå…¨éƒ¨ï¼‰
- `--max_turns`: æœ€å¤§å¯¹è¯è½®æ•°ï¼ˆé»˜è®¤ï¼š6ï¼‰
- `--concurrent_requests`: å¹¶å‘è¯·æ±‚æ•°ï¼ˆé»˜è®¤ï¼š5ï¼‰
- `--conversation_timeout`: å¯¹è¯è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤ï¼š300ç§’ï¼‰
- `--sql_timeout`: SQLæ‰§è¡Œè¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤ï¼š30ç§’ï¼‰
- `--max_result_chars`: SQLç»“æœæœ€å¤§å­—ç¬¦æ•°ï¼ˆé»˜è®¤ï¼š9000ï¼‰
- `--max_result_rows`: SQLç»“æœæœ€å¤§è¡Œæ•°ï¼ˆé»˜è®¤ï¼š50ï¼‰
- `--log_level`: æ—¥å¿—çº§åˆ«ï¼ˆé»˜è®¤ï¼šINFOï¼‰

### æ•°æ®æ ¼å¼

#### è¯„ä¼°æ•°æ®é›†æ ¼å¼

```json
[
  {
    "id": "sample_1",
    "question": "How many users are there in the database?",
    "db_id": "company_db",
    "data_source": "synsql",
    "sql": "SELECT COUNT(*) FROM users;",
    "external_knowledge": "",
    "difficulty": "easy"
  }
]
```

#### ç›®å½•ç»“æ„

```
db_root_path/
â”œâ”€â”€ spider/
â”‚   â””â”€â”€ database/
â”‚       â””â”€â”€ company_db/
â”‚           â””â”€â”€ company_db.sqlite

```

## æ¨¡å—è¯´æ˜

### 1. æ•°æ®é¢„å¤„ç†æ¨¡å— (`data_preprocess.py`)

è´Ÿè´£æ•°æ®åŠ è½½ã€Promptæ„é€ å’Œæ•°æ®åº“schemaè·å–ã€‚

```python
from sql_eval import DatabaseManager, PromptBuilder, DataProcessor

# åˆ›å»ºæ•°æ®åº“ç®¡ç†å™¨
db_manager = DatabaseManager("/path/to/databases")

# åˆ›å»ºPromptæ„é€ å™¨
prompt_builder = PromptBuilder(db_manager)

# åˆ›å»ºæ•°æ®å¤„ç†å™¨
data_processor = DataProcessor(db_manager, prompt_builder)

# åŠ è½½æ•°æ®
samples = data_processor.load_dataset("dataset.json")
```

### 2. å¯¹è¯ç®¡ç†æ¨¡å— (`conversation_manager.py`)

ç®¡ç†ä¸SGLangæœåŠ¡å™¨çš„å¤šè½®å¯¹è¯ã€‚

```python
from sql_eval import ConversationManager, SQLToolClient

# åˆ›å»ºSQLå·¥å…·å®¢æˆ·ç«¯
sql_client = SQLToolClient("/path/to/databases")

# åˆ›å»ºå¯¹è¯ç®¡ç†å™¨
async with ConversationManager(
    server_url="http://localhost:8001",
    sql_tool_client=sql_client,
    max_turns=6
) as manager:
    result = await manager.run_conversation(
        initial_messages=[
            {"role": "system", "content": "You are a helpful assistant."},
            {"role": "user", "content": "Generate SQL for: How many users?"}
        ],
        db_id="company_db",
        data_source="synsql"
    )
```

### 3. è¯„ä¼°æ¨¡å— (`evaluator.py`)

æ‰§è¡ŒSQLç»“æœçš„è¯„ä¼°å’Œæ¯”è¾ƒã€‚

```python
from sql_eval import Text2SQLEvaluator, SQLToolClient

# åˆ›å»ºè¯„ä¼°å™¨
sql_client = SQLToolClient("/path/to/databases")
evaluator = Text2SQLEvaluator(sql_client)

# è¯„ä¼°å•ä¸ªæ ·æœ¬
result, metrics = evaluator.evaluate_single_sample(
    prediction_text="<answer>SELECT COUNT(*) FROM users;</answer>",
    ground_truth_sql="SELECT COUNT(*) FROM users;",
    db_id="company_db",
    data_source="synsql"
)
```

### 4. ç»“æœåˆ†ææ¨¡å— (`result_analyzer.py`)

åˆ†æè¯„ä¼°ç»“æœå¹¶ç”ŸæˆæŠ¥å‘Šã€‚

```python
from sql_eval import ResultAnalyzer

# åˆ›å»ºåˆ†æå™¨
analyzer = ResultAnalyzer()

# åˆ†æç»“æœ
analysis = analyzer.analyze_results(evaluation_results, sample_data)

# ç”ŸæˆæŠ¥å‘Š
report = analyzer.generate_report("report.txt")
```

## è¾“å‡ºæ–‡ä»¶è¯´æ˜

è¿è¡Œå®Œæˆåï¼Œä¼šåœ¨è¾“å‡ºç›®å½•ç”Ÿæˆä»¥ä¸‹æ–‡ä»¶ï¼š

- `raw_results_YYYYMMDD_HHMMSS.json`: åŸå§‹è¯„ä¼°ç»“æœ
- `analysis_YYYYMMDD_HHMMSS.json`: è¯¦ç»†åˆ†æç»“æœ
- `report_YYYYMMDD_HHMMSS.txt`: äººç±»å¯è¯»çš„è¯„ä¼°æŠ¥å‘Š
- `sql_eval.log`: è¿è¡Œæ—¥å¿—

## è¯„ä¼°æŒ‡æ ‡

### æ ¸å¿ƒæŒ‡æ ‡

- **æ‰§è¡Œå‡†ç¡®ç‡**: SQLæŸ¥è¯¢æ‰§è¡Œç»“æœä¸æ ‡å‡†ç­”æ¡ˆçš„åŒ¹é…ç‡
- **SQLæå–ç‡**: ä»æ¨¡å‹å“åº”ä¸­æˆåŠŸæå–SQLçš„æ¯”ä¾‹
- **SQLæœ‰æ•ˆæ€§**: æå–çš„SQLè¯­æ³•æ˜¯å¦æ­£ç¡®
- **é¢„æµ‹æˆåŠŸç‡**: é¢„æµ‹SQLæ‰§è¡ŒæˆåŠŸçš„æ¯”ä¾‹
- **æ ‡å‡†ç­”æ¡ˆæˆåŠŸç‡**: æ ‡å‡†ç­”æ¡ˆSQLæ‰§è¡ŒæˆåŠŸçš„æ¯”ä¾‹

### åˆ†æç»´åº¦

- **æŒ‰éš¾åº¦åˆ†æ**: ç®€å•ã€ä¸­ç­‰ã€å›°éš¾é—®é¢˜çš„æ€§èƒ½å¯¹æ¯”
- **æŒ‰æ•°æ®æºåˆ†æ**: ä¸åŒæ•°æ®æºçš„æ€§èƒ½å¯¹æ¯”
- **é”™è¯¯ç±»å‹åˆ†æ**: è§£æé”™è¯¯ã€æ‰§è¡Œé”™è¯¯ã€ç»“æœä¸åŒ¹é…ç­‰
- **æ€§èƒ½åˆ†æ**: æ‰§è¡Œæ—¶é—´åˆ†å¸ƒã€å¹¶å‘æ€§èƒ½ç­‰

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æ•°æ®åº“æ–‡ä»¶æœªæ‰¾åˆ°**
   - æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®
   - ç¡®è®¤æ•°æ®åº“æ–‡ä»¶å­˜åœ¨ä¸”å¯è®¿é—®

2. **SGLangæœåŠ¡å™¨è¿æ¥å¤±è´¥**
   - æ£€æŸ¥æœåŠ¡å™¨URLæ˜¯å¦æ­£ç¡®
   - ç¡®è®¤æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ
   - æ£€æŸ¥ç½‘ç»œè¿æ¥

3. **SQLæ‰§è¡Œè¶…æ—¶**
   - å¢åŠ `--sql_timeout`å‚æ•°
   - æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶æ˜¯å¦æŸå
   - ä¼˜åŒ–SQLæŸ¥è¯¢å¤æ‚åº¦

4. **å†…å­˜ä¸è¶³**
   - å‡å°‘`--concurrent_requests`å‚æ•°
   - å¢åŠ `--sample_size`é™åˆ¶è¯„ä¼°æ ·æœ¬æ•°é‡
   - å‡å°‘`--max_result_chars`å’Œ`--max_result_rows`

### è°ƒè¯•æ–¹æ³•

1. **å¯ç”¨DEBUGæ—¥å¿—**
   ```bash
   python -m sql_eval.main_eval --log_level DEBUG [å…¶ä»–å‚æ•°]
   ```

2. **å°æ ·æœ¬æµ‹è¯•**
   ```bash
   python -m sql_eval.main_eval --sample_size 10 [å…¶ä»–å‚æ•°]
   ```

3. **æ£€æŸ¥æ—¥å¿—æ–‡ä»¶**
   ```bash
   tail -f sql_eval.log
   ```

## æ€§èƒ½ä¼˜åŒ–

### å¹¶å‘è°ƒä¼˜

- æ ¹æ®æœåŠ¡å™¨æ€§èƒ½è°ƒæ•´`--concurrent_requests`
- ç›‘æ§ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ
- é¿å…è¿‡é«˜çš„å¹¶å‘å¯¼è‡´æœåŠ¡å™¨è¿‡è½½

### æ•°æ®åº“ä¼˜åŒ–

- ç¡®ä¿æ•°æ®åº“æ–‡ä»¶å­˜å‚¨åœ¨é«˜é€Ÿå­˜å‚¨è®¾å¤‡ä¸Š
- å®šæœŸæ£€æŸ¥æ•°æ®åº“æ–‡ä»¶å®Œæ•´æ€§
- ä½¿ç”¨SSDæé«˜æŸ¥è¯¢æ€§èƒ½

### ç½‘ç»œä¼˜åŒ–

- ç¡®ä¿è¯„ä¼°å®¢æˆ·ç«¯å’ŒSGLangæœåŠ¡å™¨ä¹‹é—´ç½‘ç»œå»¶è¿Ÿä½
- è€ƒè™‘åœ¨åŒä¸€å°æœºå™¨ä¸Šè¿è¡Œä»¥é¿å…ç½‘ç»œå¼€é”€

## æ‰©å±•å¼€å‘

### æ·»åŠ æ–°çš„æ•°æ®æº

1. åœ¨`DatabaseManager.get_db_path()`ä¸­æ·»åŠ æ–°çš„æ•°æ®æºé€»è¾‘
2. æ›´æ–°æ•°æ®å¤„ç†å™¨ä»¥æ”¯æŒæ–°çš„æ•°æ®æ ¼å¼
3. æ·»åŠ ç›¸åº”çš„æµ‹è¯•ç”¨ä¾‹

### è‡ªå®šä¹‰è¯„ä¼°æŒ‡æ ‡

1. ç»§æ‰¿`EvaluationMetrics`ç±»
2. åœ¨`Text2SQLEvaluator`ä¸­å®ç°æ–°çš„è¯„ä¼°é€»è¾‘
3. æ›´æ–°ç»“æœåˆ†æå™¨ä»¥æ”¯æŒæ–°æŒ‡æ ‡

### æ·»åŠ æ–°çš„æ¨¡å‹æœåŠ¡å™¨

1. åœ¨`ConversationManager`ä¸­æ·»åŠ æ–°çš„APIé€‚é…å™¨
2. å®ç°ç›¸åº”çš„æ¶ˆæ¯æ ¼å¼è½¬æ¢
3. æ·»åŠ é…ç½®å‚æ•°æ”¯æŒ
